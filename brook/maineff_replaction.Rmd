---
title: "Replicating main effects analysis"
author: "Brook Luers"
date: "July 7, 2016"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(gridExtra)
library(knitr)
library(grid)
library(reshape2)
library(geepack)
library(Matrix)

source('../init.R', chdir=TRUE)
source('../xgeepack.R')
if (!exists('suggest')){
  load(paste(sys.var$mbox.data,'csv.RData',sep=''))
  load(paste(sys.var$mbox.data,"analysis.RData",sep=''))
}
```

## Inclusion/Exclusion
```{r include_exclude, echo=FALSE}

unavail_sent_slots <-
            filter(suggest, !avail & !is.na(notification.message))%>%
                select(user, study.day.nogap, slot, avail, notification.message) %>%
  mutate('Message sent' = !is.na(notification.message)) %>% select(-notification.message) %>%
  rename('User' = user, 'Non-travel study day'= study.day.nogap,
         'Decision slot' = slot, 'Available' = avail)
no_message_tag <- 
            filter(suggest, send & !travel & study.day.nogap <= 42 & is.na(send.sedentary)) %>%
                select(user, study.day.nogap, slot, 
                      notification.message) %>%
  rename('User' = user,
         'Non-travel study day' = study.day.nogap,
         'Decision slot' = slot,
         'Sent mesasge' = notification.message)

ntravel <- sum(suggest$travel)
npost41 <- with(suggest, sum(study.day.nogap > 41, na.rm=T))
nexclude <- 
  ntravel + npost41 + nrow(unavail_sent_slots) + nrow(no_message_tag)

suggest.included <- 
  suggest %>%
  filter(!travel & study.day.nogap <= 41) %>%
  anti_join(mutate(no_message_tag, no_message_tag = T),
            by=c('user'='User','study.day.nogap'='Non-travel study day',
                 'slot'='Decision slot')) %>%
  anti_join(mutate(unavail_sent_slots, unavail_sent_slots = T),
            by=c('user'='User','study.day.nogap'='Non-travel study day',
                 'slot'='Decision slot'))

navail <- sum(suggest.included$avail)

```

* **Valid** decision points occurred within intended timeslot and are not duplicated: `r nrow(suggest)`
* **Excluded** decision points (`r nexclude`):
    + Exclude decision points during travel days (`r ntravel`)
        ```{r table-travel, echo=FALSE}
            with(suggest, table(`Traveling at decision point?` = travel, exclude=NULL))
        ```
    + Exclude decision points past the 42nd consecutive, non-travel study day (`r npost41`)
    + Exclude decision points when the user was unavailable but a message was still sent (`r nrow(unavail_sent_slots)`)
        ```{r unavail-sent, echo=FALSE}
          print(unavail_sent_slots)
        ```
    + Exclude decision points where the notification message is blank (`r nrow(no_message_tag)`):
        ```{r no-active-sedentary, echo=FALSE}
            print(no_message_tag)
        ```
* **Included** decision points: `r nrow(suggest) - nexclude` = valid -- excluded = `r nrow(suggest)` -- `r nexclude`
* **Available** decision points: `r navail` = included -- unavailable
          ```{r avail-print, echo=FALSE}
                with(suggest.included, table('Available?'=avail))
          ```

## sandwich estimator
All of the following assumes an independent working correlation structure.

Notation:

* $X_j$ is the design matrix for the $j$th user.
* $W_j$ is the diagonal matrix of weights for the $j$th user. The models given below use availability, $I_t \in \left\{0,1\right\}$, as the weights.
* $\hat{\epsilon}_j$ is the vector of residuals for the $j$th user.
* $H_{jj} = X_j\left(\sum_k X_k^\intercal W_k X_k\right)^{-1} X_j^\intercal W_j$ is the hat matrix for the $j$th user.

Unadjusted sandwich estimator:
$$ \left(X^\intercal W X\right)^{-1} \left[\sum_j X_j^\intercal W_j \hat{\epsilon}_j \hat{\epsilon}_j^\intercal W_j X_j\right]\left(X^\intercal W X\right)^{-1}$$

Mancl & DeRouen adjusted sandwich estimator:
$$\left(X^\intercal W X\right)^{-1} \left[\sum_j X_j^\intercal W_j\left(I - H_{jj}\right)^{-1} \hat{\epsilon}_j \hat{\epsilon}_j^\intercal\left(I - H_{jj}\right)^{-1} W_j X_j\right]\left(X^\intercal W X\right)^{-1} $$

## Modeling

```{r vcov-function, echo=FALSE}
# Calculate the sandwich variance-covariance estimator
# Independent working correlation
# small = TRUE for the Mancl & DeRouen adjustment
vcov.heartsteps.bgl <- function(x, small = TRUE){
  require(Matrix)
  X <- model.matrix(x)
  ids <- x$geese$id
  Xl <- split(as.data.frame(X), ids)
  residl <- split(x$y - x$fitted.values, ids)
  meatmat <- matrix(0, nrow=ncol(X), ncol=ncol(X))
  W <- diag(x$geese$weights) # matrix of all weights
  Wl <- split(x$geese$weights, ids) # list of vectors
  XWXi <- solve(crossprod(X, W) %*% X) # BREAD
  for (i in 1:length(Xl)){
    Xj <- as.matrix(Xl[[i]]) # Design matrix for this user
    ej <- residl[[i]] # Residuals for this user
    Wj <- diag(Wl[[i]]) # Weights for this user
    Inj <- diag(ncol(Wj)) # Identity of size n_j
    adj_mat <- Inj 
    XtWj <- crossprod(Xj, Wj) # t(X_j) * W_j
    if (small){
      Hjj <- Xj %*% XWXi %*% XtWj # Hat matrix for jth user
      adj_mat <- solve(Inj - Hjj) # Adjustment matrix
    }
    Mj <- XtWj %*% adj_mat %*% ej # p by 1 vector
    meatmat <- meatmat + tcrossprod(Mj)
  }
  return(XWXi %*% meatmat %*% XWXi) # sandwich estimator
}

```
Missing values:

* The following models impute 0 for any time interval with a missing step count.
Notation:
* $Y_{t+1}$ is log(stepcount + 0.5) in the 30 minutes following the $t$th decision point.
* $Z_t$ is log(stepcount + 0.5) in the 30 minutes prior to the $t$th decision point.
* $A_t$ indicator of treatment at decision point $t$.
* $I_t \in \left\{0,1\right\}$ indicator of availability at the $t$th decision point.
* $d(t) \in \left\{0,1,\ldots,41\right\}$ index of the day of the $t$th decision point.

### Model 1

$$Y_{t+1} = \alpha_0 + \alpha_1 Z_t + \beta_1(A_t - 0.6)$$

The weight matrix has diagonal elements equal to the availability indicator $I_t$.
          
```{r model1, echo=FALSE, cache=TRUE}
# jbsteps30.zero is the zero-imputed raw step count in the 30 minutes after decision
# jbsteps30.log = log(jbsteps30.zero + 0.5)
# jbsteps30pre.zero is the zero-imputed raw step count in the 30 minutes prior to decision
# jbsteps30pre.log = log(jbsteps30pre.zero + 0.5)
# A_t = send
suggest.analysis <-
  suggest.included %>%
    arrange(user, study.day.nogap, decision.index.nogap)

mod1.brook <- 
  geeglm(
  jbsteps30.log ~ jbsteps30pre.log + I(send - 0.6),
  id = user, 
  corstr = 'independence',
  weights = as.numeric(suggest.analysis$avail),
  scale.fix = TRUE,
  data = suggest.analysis
)

```

Estimates and standard errors:

```{r mod1-results, echo=FALSE, results='asis'}

#aud1 <- diag(vcov.geeglm(mod1.brook, small=T))
brook1 <- diag(vcov.heartsteps.bgl(mod1.brook, small=T))

tt <- cbind('Estimate' = coef(mod1.brook),
            "SE" = sqrt(brook1))
            #"SE (Audrey's code)" = sqrt(aud1))
rownames(tt) <- c('$\\alpha_0$', '$\\alpha_1$','$\\beta_1$')

#print(xtable(tt, digits=c(0,3,4)), type='html',
#      include.rownames=TRUE,
#      include.colnames=TRUE)
kable(tt,
      digits = c(3,4),
      padding=0)

```

