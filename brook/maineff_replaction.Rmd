---
title: "Replicating main effects analysis"
author: "Brook Luers"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(gridExtra)
library(knitr)
library(grid)
library(reshape2)
library(geepack)
library(Matrix)

source('../init.R', chdir=TRUE)
source('../xgeepack.R')
if (!exists('suggest')){
  load(paste(sys.var$mbox.data,'csv.RData',sep=''))
  load(paste(sys.var$mbox.data,"analysis.RData",sep=''))
}

gridline <- element_line(color='lightgrey',linetype='dashed')
ptheme <-
  theme_bw(base_size = 11) +
  theme(panel.grid.major.x=gridline,
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=gridline,
        panel.grid.minor.y=element_blank(),
        strip.background=element_rect(fill=NA,color='white'),
        legend.position='right',
        legend.direction='vertical')
```

## Inclusion/Exclusion
```{r include_exclude, echo=FALSE}

unavail_sent_slots <-
            filter(suggest, !avail & !is.na(notification.message))%>%
                select(user, study.day.nogap, slot, avail, notification.message) %>%
  mutate('Message sent' = !is.na(notification.message)) %>% select(-notification.message) %>%
  rename('User' = user, 'Non-travel study day'= study.day.nogap,
         'Decision slot' = slot, 'Available' = avail)
no_message_tag <- 
            filter(suggest, send & !travel & study.day.nogap <= 42 & is.na(send.sedentary)) %>%
                select(user, study.day.nogap, slot, 
                      notification.message) %>%
  rename('User' = user,
         'Non-travel study day' = study.day.nogap,
         'Decision slot' = slot,
         'Sent mesasge' = notification.message)

ntravel <- sum(suggest$travel)
npost41 <- with(suggest, sum(study.day.nogap > 41, na.rm=T))
nexclude <- 
  ntravel + npost41 + nrow(unavail_sent_slots) + nrow(no_message_tag)

suggest.included <- 
  suggest %>%
  filter(!travel & study.day.nogap <= 41) %>%
  anti_join(mutate(no_message_tag, no_message_tag = T),
            by=c('user'='User','study.day.nogap'='Non-travel study day',
                 'slot'='Decision slot')) %>%
  anti_join(mutate(unavail_sent_slots, unavail_sent_slots = T),
            by=c('user'='User','study.day.nogap'='Non-travel study day',
                 'slot'='Decision slot'))

navail <- sum(suggest.included$avail)

```

* **Valid** decision points occurred within intended timeslot and are not duplicated: `r nrow(suggest)`
* **Excluded** decision points (`r nexclude`):
    + Exclude decision points during travel days (`r ntravel`)
        ```{r table-travel, echo=FALSE}
            with(suggest, table(`Traveling at decision point?` = travel, exclude=NULL))
        ```
    + Exclude decision points past the 42nd consecutive, non-travel study day (`r npost41`)
    + Exclude decision points when the user was unavailable but a message was still sent (`r nrow(unavail_sent_slots)`)
        ```{r unavail-sent, echo=FALSE}
          print(unavail_sent_slots)
        ```
    + Exclude decision points where the notification message is blank (`r nrow(no_message_tag)`):
        ```{r no-active-sedentary, echo=FALSE}
            print(no_message_tag)
        ```
* **Included** decision points: `r nrow(suggest) - nexclude` = valid -- excluded = `r nrow(suggest)` -- `r nexclude`
* **Available** decision points: `r navail` = included -- unavailable
          ```{r avail-print, echo=FALSE}
                with(suggest.included, table('Available?'=avail))
          ```


```{r plot-all, echo=FALSE, include=FALSE, eval=FALSE}

suggest.included %>%
  mutate(study.day.nogap.f = factor(study.day.nogap, levels=0:41,
                                  labels=paste(c('Study day ',rep('',41)),
                                               0:41,sep=''))) %>%
  filter(avail) %>%
  ggplot(aes(x=log(jbsteps30pre + 0.5), y=log(jbsteps30 + 0.5))) +
  geom_point(aes(shape=send, color=send)) +
  ptheme +
  facet_wrap(~study.day.nogap.f) +
  scale_shape_discrete(solid=F) + 
  scale_color_brewer(palette='Set1') +
  xlab(expression(Z[t])) + ylab(expression(Y[t+1]))
  

```



## Sandwich Estimator
All of the following assumes an independent working correlation structure.

Notation:

* $X_j$ is the design matrix for the $j$th user.
* $W_j$ is the diagonal matrix of weights for the $j$th user. The models given below use availability, $I_t \in \left\{0,1\right\}$, as the weights.
* $\hat{\epsilon}_j$ is the vector of residuals for the $j$th user.
* $H_{jj} = X_j\left(\sum_k X_k^\intercal W_k X_k\right)^{-1} X_j^\intercal W_j$ is the hat matrix for the $j$th user.

Unadjusted sandwich estimator:
$$ \left(X^\intercal W X\right)^{-1} \left[\sum_j X_j^\intercal W_j \hat{\epsilon}_j \hat{\epsilon}_j^\intercal W_j X_j\right]\left(X^\intercal W X\right)^{-1}$$

Mancl & DeRouen adjusted sandwich estimator:
$$\left(X^\intercal W X\right)^{-1} \left[\sum_j X_j^\intercal W_j\left(I - H_{jj}\right)^{-1} \hat{\epsilon}_j \hat{\epsilon}_j^\intercal\left(I - H_{jj}\right)^{-1} W_j X_j\right]\left(X^\intercal W X\right)^{-1} $$

## Models

```{r estimate-functions, echo=FALSE}
source('estimation_functions_brook.R')

```

Missing values: The following models impute 0 for any time interval with a missing step count.

Notation:

* $Y_{t+1}$ is log(stepcount + 0.5) in the 30 minutes following the $t$th decision point.
* $Z_t$ is log(stepcount + 0.5) in the 30 minutes prior to the $t$th decision point.
* $A_t$ indicator of treatment at decision point $t$.
* $I_t \in \left\{0,1\right\}$ indicator of availability at the $t$th decision point.
* $d(t) \in \left\{0,1,\ldots,41\right\}$ index of the day of the $t$th decision point.

### Model 1

$$Y_{t+1} = \alpha_0 + \alpha_1 Z_t + \beta_1(A_t - 0.6)$$

The weight matrix has diagonal elements equal to the availability indicator $I_t$.
          
```{r model1, echo=FALSE, cache=FALSE}
# jbsteps30.zero is the zero-imputed raw step count in the 30 minutes after decision
# jbsteps30.log = log(jbsteps30.zero + 0.5)
# jbsteps30pre.zero is the zero-imputed raw step count in the 30 minutes prior to decision
# jbsteps30pre.log = log(jbsteps30pre.zero + 0.5)
# A_t = send
suggest.analysis <-
  suggest.included %>%
    arrange(user, study.day.nogap, decision.index.nogap)

mod1.brook <- 
  geeglm(
  jbsteps30.log ~ jbsteps30pre.log + I(send - 0.6),
  id = user, 
  corstr = 'independence',
  weights = as.numeric(suggest.analysis$avail),
  scale.fix = TRUE,
  data = suggest.analysis
)

```

Estimates and standard errors:

```{r mod1-results, echo=FALSE, results='asis'}

vcov1.brook <- vcov.heartsteps.bgl(mod1.brook, small=T)
se1.brook <- diag(vcov1.brook)
coef1.brook <- coef(mod1.brook)


test1 <- pointwise.table.small(coef1.brook,
                               vcov1.brook,
                               n=length(mod1.brook$geese$clusz),
                               alpha=0.05)

tt <- cbind('Estimate' = coef1.brook,
            "SE" = sqrt(se1.brook),
            test1)
rownames(tt) <- c('$\\alpha_0$', '$\\alpha_1$','$\\beta_1$')
colnames(tt)[3:6] <- c('Hotelling','p-value','95% LCL','95% UCL')

kable(tt,
      digits = c(3,4,2,3,3,3),
      padding=0)

```

### Model 2

$$Y_{t+1} = \alpha_0 + \alpha_1 Z_t + \alpha_2 d(t) + \beta_1(A_t - 0.6) + \beta_2 d(t) (A_t - 0.6)$$

Same weighting as in model 1.


```{r model2, echo=FALSE, cache=FALSE}

mod2.brook <- 
  geeglm(
  jbsteps30.log ~ jbsteps30pre.log + study.day.nogap +
                  I(send - 0.6) + study.day.nogap:I(send - 0.6),
  id = user, 
  corstr = 'independence',
  weights = as.numeric(suggest.analysis$avail),
  scale.fix = TRUE,
  data = suggest.analysis
)

```

Estimates and standard errors:
```{r model2-results, echo=FALSE, results='asis'}

vcov2.brook <- vcov.heartsteps.bgl(mod2.brook, small=TRUE)
se2.brook <- diag(vcov2.brook)
coef2.brook <- coef(mod2.brook)

test2 <- pointwise.table.small(coef2.brook, vcov2.brook,
                               n=length(mod2.brook$geese$clusz),
                               alpha=0.05)

tt <- cbind('Estimate' = coef2.brook,
            "SE" = sqrt(se2.brook),
            test2)
rownames(tt) <- c('$\\alpha_0$', '$\\alpha_1$',
                  '$\\alpha_2$', '$\\beta_1$', '$\\beta_2$')
colnames(tt)[3:6] <- c('Hotelling','p-value','95% LCL','95% UCL')

#kable(tt, digits=2,
#      padding=0)
print(xtable(tt,
             digits=c(0,5,4,2,3,3,3)),
      sanitize.rownames.function=identity,
      comment=FALSE)

```

### Model with quadratic time

$$Y_{t+1} = \alpha_0 + \alpha_1 Z_t + \alpha_2 d(t) + \alpha_3 d(t)^2 + \beta_1(A_t - 0.6) + \beta_2 d(t) (A_t - 0.6) + \beta_3 d(t)^2(A_t - 0.6)$$


```{r mod3-quadratic, echo=FALSE}

mod3.brook <- 
  geeglm(
  jbsteps30.log ~ jbsteps30pre.log + study.day.nogap + I(study.day.nogap^2) +
                  I(send - 0.6) + study.day.nogap:I(send - 0.6) +
                  I(study.day.nogap^2):I(send - 0.6),
  id = user, 
  corstr = 'independence',
  weights = as.numeric(suggest.analysis$avail),
  scale.fix = TRUE,
  data = suggest.analysis
)

```

```{r mod3-results, echo=FALSE, results='asis'}

coef3.brook <- coef(mod3.brook)
vcov3.brook <- vcov.heartsteps.bgl(mod3.brook, small=TRUE)
se3.brook <- diag(vcov3.brook)

test3 <- pointwise.table.small(coef3.brook, vcov3.brook,
                               n=length(mod3.brook$geese$clusz),
                               alpha=0.05)


tt <- cbind('Estimate' = coef3.brook,
            "SE" = sqrt(se3.brook),
            test3)
rownames(tt) <- c('$\\alpha_0$', '$\\alpha_1$',
                  '$\\alpha_2$', '$\\alpha_3$',
                  '$\\beta_1$', '$\\beta_2$', '$\\beta_3$')
colnames(tt)[3:6] <- c('Hotelling','p-value','95% LCL','95% UCL')
#kable(tt,
#      digits = c(5,3,2,3,3,3),
#      padding=0)
print(xtable(tt,
             digits=c(0,5,4,2,3,3,3)),
      sanitize.rownames.function=identity,
      comment=FALSE)

```

## Time trend

(Include unavailable decision points in residual plots?)

### Prior step count only (Nick's model 3)
$$ Y_{t+1} \sim \alpha_0 + \alpha_1 Z_t$$

```{r time1, echo=FALSE}

timemod1 <- 
  geeglm(
  jbsteps30.log ~ jbsteps30pre.log,
  id = user, 
  corstr = 'independence',
  weights = as.numeric(suggest.analysis$avail),
  scale.fix = TRUE,
  data = suggest.analysis
  )

#pointwise.table.small(coef(timemod1), S=vcov.heartsteps.bgl(timemod1,small = T),
#                      n=length(timemod1$geese$clusz))


plotdf <- data.frame(
  resid = timemod1$y - timemod1$fitted.values,
  send = timemod1$data$send,
  study.day.nogap = timemod1$data$study.day.nogap,
  avail = timemod1$data$avail
)

plotdf <- bind_rows(
  'All decision points'=plotdf,
  'Available decision points'=filter(plotdf, avail),
  .id='availability'
)

span <- 0.5
plot.resid.time1 <- 
  plotdf %>%
  ggplot(aes(x=study.day.nogap, y=resid)) + 
  geom_point(aes(color=send), shape=1,alpha=I(1/2)) + 
  geom_smooth(aes(group=send,color=send), method='loess',se=F,
              span=span) +
  ptheme + scale_color_brewer(palette='Set1',
                              name=paste('Loess smoother,',span,'span'), 
                              breaks=c('FALSE','TRUE'),
                              labels=c('No suggestion','Suggestion')) +
  ylab('Residual') + xlab('Study day') +
  facet_grid(.~availability)+
  ggtitle(expression(alpha[0] + alpha[1]~Z[t]))
  

```

Residuals versus time:

```{r plot-resid-time1,echo=FALSE, fig.width=8.5,fig.height=4.5}

plot.resid.time1

```

### Quadratic time (Nick's model 4)

```{r time2, echo=FALSE}


timemod2 <- 
  geeglm(
  jbsteps30.log ~ jbsteps30pre.log + study.day.nogap + I(study.day.nogap^2),
  id = user, 
  corstr = 'independence',
  weights = as.numeric(suggest.analysis$avail),
  scale.fix = TRUE,
  data = suggest.analysis
  )

plotdf2 <- data.frame(
  resid = timemod2$y - timemod2$fitted.values,
  send = timemod2$data$send,
  study.day.nogap = timemod2$data$study.day.nogap,
  avail = timemod2$data$avail
)
plotdf2 <- bind_rows(
  'All decision points' = plotdf2,
  'Available decision points' = filter(plotdf2, avail),
  .id='availability'
)

plot.resid.time2 <- 
  plotdf2 %>%
  ggplot(aes(x=study.day.nogap, y=resid)) + 
  geom_point(aes(color=send), shape=1,alpha=I(1/2)) + 
  geom_smooth(aes(group=send,color=send), method='loess',se=F,
              span=span) +
  ptheme + scale_color_brewer(palette='Set1',
                              name=paste('Loess smoother,',span,'span'), 
                              breaks=c('FALSE','TRUE'),
                              labels=c('No suggestion','Suggestion')) +
  ylab('Residual') + xlab('Study day') +
  facet_grid(.~availability)+
  ggtitle(expression(alpha[0] + alpha[1]~Z[t] + alpha[2]~d(t)+alpha[3]~d(t)^2))

```

Residuals versus time:

```{r plot-resid-time2, echo=FALSE, fig.width=8.5, fig.height=4.5}
plot.resid.time2

```



```{r plot-res2, echo=FALSE}

plotdat <- 
  expand.grid(jbsteps30pre = seq(0, 5500, length.out=150),
              study.day.nogap = 0:41,
              send = c(0,1)) %>%
  mutate(jbsteps30pre.log = log(jbsteps30pre + 0.5))
plotdat$jbsteps30.log <- numeric(nrow(plotdat))

plotdatmat1 <- model.matrix(formula(mod1.brook), data=plotdat)
plotdatmat2 <- model.matrix(formula(mod2.brook), data=plotdat)

plotdat$jbsteps30.log2 <- as.numeric(plotdatmat2 %*% coef(mod2.brook))
plotdat$jbsteps30.log1 <- as.numeric(plotdatmat1 %*% coef(mod1.brook))

plot.mod2.mean <-
  plotdat %>%
  mutate(study.day.nogap.f = factor(study.day.nogap, levels=0:41,
                                  labels=paste(c('Study day ',rep('',41)),
                                               0:41,sep=''))) %>%
  filter(study.day.nogap %in% seq(0,41,by=2)) %>%
  ggplot(aes(x=exp(jbsteps30pre.log) - 0.5, y=exp(jbsteps30.log2) - 0.5)) +
  geom_line(aes(group=send, linetype=as.factor(send))) +
  facet_wrap(~study.day.nogap.f, nrow=4) + 
  ptheme + xlab('Steps 30 minutes prior') + ylab('Steps 30 minutes after') +
  scale_linetype_discrete(name='', breaks=c(0,1),
                          labels=c('No suggestion','Suggestion')) +
  theme(legend.position=c(1, 0),
        legend.justification=c(1,0),
        legend.direction='vertical') 

```

```{r plot-mod2-print, echo=FALSE, fig.width=7, fig.height=6, include=FALSE}
plot.mod2.mean + ggtitle('Conditional mean in Model 2')
```
