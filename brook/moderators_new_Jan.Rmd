---
title: "Additonal Moderators"
author: "Brook Luers"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(gridExtra)
library(knitr)
library(grid)
library(reshape2)
library(geepack)
library(Matrix)


source('../init.R', chdir=TRUE)
if (!exists('suggest')){
  load(paste(sys.var$mbox.data,'csv.RData',sep=''))
  load(paste(sys.var$mbox.data,"analysis-small.RData",sep=''))
}
gridline <- element_line(color='lightgrey',linetype='dashed')
ptheme <-
  theme_bw(base_size = 11) +
  theme(panel.grid.major.x=gridline,
        panel.grid.minor.x=element_blank(),
        panel.grid.major.y=gridline,
        panel.grid.minor.y=element_blank(),
        strip.background=element_rect(fill=NA,color='white'),
        legend.position='right',
        legend.direction='vertical')
```


```{r, sug-analysis,echo=FALSE }

unavail_sent_slots <-
            filter(suggest, !avail & !is.na(notification.message))%>%
                select(user, study.day.nogap, slot, avail, notification.message) %>%
  mutate('Message sent' = !is.na(notification.message)) %>% select(-notification.message) %>%
  rename('User' = user, 'Non-travel study day'= study.day.nogap,
         'Decision slot' = slot, 'Available' = avail)
no_message_tag <- 
            filter(suggest, send & !travel & study.day.nogap <= 42 & is.na(send.sedentary)) %>%
                select(user, study.day.nogap, slot, 
                      notification.message) %>%
  rename('User' = user,
         'Non-travel study day' = study.day.nogap,
         'Decision slot' = slot,
         'Sent mesasge' = notification.message)

ntravel <- sum(suggest$travel)
npost41 <- with(suggest, sum(study.day.nogap > 41, na.rm=T))
nexclude <- 
  ntravel + npost41 + nrow(unavail_sent_slots) + nrow(no_message_tag)

suggest.included <- 
  suggest %>%
  filter(!travel & study.day.nogap <= 41) %>%
  anti_join(mutate(no_message_tag, no_message_tag = T),
            by=c('user'='User','study.day.nogap'='Non-travel study day',
                 'slot'='Decision slot')) %>%
  anti_join(mutate(unavail_sent_slots, unavail_sent_slots = T),
            by=c('user'='User','study.day.nogap'='Non-travel study day',
                 'slot'='Decision slot'))
suggest.analysis <-
  suggest.included %>%
    arrange(user, study.day.nogap, decision.index.nogap)

navail <- sum(suggest.included$avail)

```

## Missingness of thumbs up/down
Out of `r sum(with(suggest.analysis,send==TRUE))` decision points when a message was sent.
```{r, thumbs-summary}

thumbcounts <-
  xtabs(~response+avail, data=suggest.analysis, subset=send==TRUE,
        exclude=NULL, na.action=NULL)

kable(cbind(thumbcounts, round(thumbcounts /sum(thumbcounts),4)),
      col.names=c('Number decision points','Proportion'))

```

## Proportion of sent messages with a "thumbs" response

Denominator: number of prior decision points for which a suggestion message was sent and the response is non-missing.

Numerator: number of prior decision points for which a suggestion message was sent and the response is thumbs up ("good") or thumbs down ("bad").

When the denominator is zero, set the proportion equal to zero.
```{r, prev-prop-thumbs}
## Add indicators for non-missing response and up/down
suggest.analysis <-
  suggest.analysis %>%
  mutate(have_thumbs = !is.na(response),
         thumbs_up_or_down = ifelse(is.na(response), NA,
                                    response %in% c("good","bad"))) 

suggest.analysis <-
  suggest.analysis %>%
  group_by(user) %>%
  mutate(n_prev_sent_have_response =
           cumsum(send & have_thumbs),
         n_prev_thumbs_updown = 
           cumsum(have_thumbs & thumbs_up_or_down),
         prop_prev_thumbs_updown = 
           ifelse(n_prev_sent_have_response==0, 0, # Setting 0/0 = 0
                  n_prev_thumbs_updown / n_prev_sent_have_response)) %>%
  ungroup

```


```{r, plot-prop-updown,fig.align='center',fig.width=6,fig.height=3,out.width='0.75\\textwidth'}
suggest.analysis %>%
  #filter(user==10) %>%
  ggplot()+
  geom_line(aes(x=decision.index.nogap,y=prop_prev_thumbs_updown,
                group=user),alpha=I(1/3)) +
  ptheme + xlab('Decision point') + ylab('Proportion of prior messages\nwith up/down response')

```

### Sliding window

```{r, window-thumbs-proportion}
# Use a sliding window for the proportion of previous messages 
# that were given either thumbs up or thumbs down
ndays_window_thumbs <- 7 # the window in DAYS

# Get the cumulative number of sent messages with a response from ndays_window_thumbs
# days before (take the count at the end of the day, so the window slides on the day scale) 
suggest.analysis <-
  suggest.analysis %>%
  left_join( 
    suggest.analysis %>%
      filter(slot==5) %>%
      mutate(study.day.plus7 = study.day.nogap + ndays_window_thumbs,
             n_out7_sent_have_response = n_prev_sent_have_response,
             n_out7_thumbs_updown = n_prev_thumbs_updown) %>%
      select(user, study.day.plus7, n_out7_sent_have_response,
             n_out7_thumbs_updown),
    by=c('user'='user','study.day.nogap'='study.day.plus7')
  ) %>%
  mutate(n_window_sent_have_response = 
           n_prev_sent_have_response - ifelse(is.na(n_out7_sent_have_response),
                                              0,
                                              n_out7_sent_have_response),
         n_window_thumbs_updown =
           n_prev_thumbs_updown - ifelse(is.na(n_out7_thumbs_updown),
                                              0,
                                              n_out7_thumbs_updown),
         prop_window_thumbs_updown =
           ifelse(n_window_sent_have_response==0, 0,
                  n_window_thumbs_updown / n_window_sent_have_response))
```

Compute the same proportion using a sliding `r ndays_window_thumbs`-day window, including the current day. 
The window slides on the day scale even though the proportion changes on the decision point scale.
Here's an example of how the proportion is calculated for a single user.

```{r, fig.align='center',fig.width=8.5,fig.height=6,out.width='\\textwidth'}
suggest.analysis %>%
  filter(user==6,study.day.nogap %in% 0:8) %>%
  select(user,decision.index.nogap,denominator=n_prev_sent_have_response,
         numerator=n_prev_thumbs_updown,study.day.nogap,
         window_denominator=n_window_sent_have_response,
         window_numerator=n_window_thumbs_updown) %>%
  melt(id=c('user','decision.index.nogap','study.day.nogap'))%>%
  ggplot(aes(x=decision.index.nogap,y=value))+
  geom_line() + geom_point()+ facet_grid(variable~.) +
  geom_vline(aes(xintercept=decision.index.nogap),
             data=filter(suggest.analysis,user==6,study.day.nogap %in%0:8,slot==5))+
  scale_y_continuous(breaks=seq(0,16,by=2)) +
  xlab('Decision point') + ylab('num. decision points')
```

Here's the proportion using the sliding `r ndays_window_thumbs`-day window for all users.

```{r,fig.width=6,fig.height=4,out.width='0.75\\textwidth'}
suggest.analysis %>%
  #filter(user==10) %>%
  ggplot()+
  geom_line(aes(x=decision.index.nogap,y=prop_window_thumbs_updown,
                group=user),alpha=I(1/3)) +
  ptheme + xlab('Decision point') + ylab('Proportion of prior messages\nwith up/down response')+
  ggtitle(paste("Sliding ",ndays_window_thumbs,'-day window',sep=''))
```

## Step count in the last 7 days

```{r, window-daily-count}
# Step count from previous 7 days, excluding current day
# NA daily step counts add 0 to the moving-window step count
suggest.analysis <-
  suggest.analysis %>%
  left_join(
      daily %>%
        filter(!is.na(study.day.nogap))%>%
        mutate(jbsteps.agg.NA0 =ifelse(is.na(jbsteps.agg),0,jbsteps.agg)) %>%
        group_by(user) %>%
        mutate(cumsteps = cumsum(jbsteps.agg.NA0),
               steps.window7 = cumsteps - lag(cumsteps, 7, default=0),
               study.day.plus1 = study.day.nogap + 1) %>% ungroup %>%
          select(user,steps.window7, study.day.plus1),
    by=c('user'='user','study.day.nogap'='study.day.plus1') 
  ) %>%
  left_join(daily%>%select(user,study.day.nogap,daily.jbsteps.agg=jbsteps.agg),
            by=c('user'='user','study.day.nogap'='study.day.nogap'))

```

```{r,fig.align='center',fig.width=7,fig.height=4,out.width='0.9\\textwidth',include=FALSE,eval=FALSE}
suggest.analysis %>%
  filter(user==6,study.day.nogap%in%0:10) %>%
  mutate(csteps = cumsum(ifelse(slot==1,daily.jbsteps.agg,0)))%>%
  ggplot(aes(x=decision.index.nogap,y=csteps)) +
  geom_line() +
  geom_line(aes(x=decision.index.nogap,y=steps.window7),
            color='red')+geom_point()+
  geom_vline(aes(xintercept=decision.index.nogap),
             color='grey',
             data=filter(suggest.analysis,user==6,study.day.nogap%in%0:10,slot==5)) + 
  ptheme
```